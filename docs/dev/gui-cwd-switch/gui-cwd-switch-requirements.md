---
feature: gui-cwd-switch
complexity: standard
generated_by: clarify
generated_at: 2026-01-21T09:30:00Z
version: 1
---

# 需求文档: GUI 工作目录切换与服务重启

> **功能标识**: gui-cwd-switch
> **复杂度**: standard
> **生成方式**: clarify
> **生成时间**: 2026-01-21T09:30:00Z

## 1. 概述

### 1.1 一句话描述
在 docx-server-gui-launcher 中添加工作目录切换功能，支持用户通过文件夹选择对话框切换工作目录，并自动重启 MCP 服务器。

### 1.2 核心价值
- **解决的问题**: 当前 GUI 启动器无法动态切换工作目录，用户需要在不同项目间切换时必须手动重启 GUI 或修改配置文件
- **带来的价值**:
  - 提升多项目工作效率，一键切换无需重启应用
  - 保存历史目录记录，支持快速切换常用项目
  - 自动化服务重启流程，减少手动操作错误

### 1.3 目标用户
- **主要用户**: 使用 docx-mcp-server GUI 启动器的开发者和文档编辑人员
- **使用场景**: 需要在多个项目/文档目录之间频繁切换

---

## 2. 需求与用户故事

### 2.1 需求清单

| ID | 需求点 | 优先级 | 用户故事 |
|----|--------|--------|----------|
| R-001 | 工作目录选择 | P0 | As a user, I want 通过文件夹选择对话框选择工作目录, so that 可以方便地浏览和选择目标路径 |
| R-002 | 自动重启服务 | P0 | As a user, I want 切换目录后自动重启服务, so that 无需手动停止和启动服务 |
| R-003 | 当前目录显示 | P0 | As a user, I want 在 GUI 中看到当前工作目录, so that 清楚当前服务运行在哪个目录 |
| R-004 | 重启进度提示 | P0 | As a user, I want 看到重启过程的状态提示, so that 知道服务正在重启且何时完成 |
| R-005 | 错误处理 | P0 | As a user, I want 切换失败时看到明确的错误提示, so that 了解失败原因并采取措施 |
| R-006 | 配置持久化 | P1 | As a user, I want 切换的目录被保存下来, so that 下次启动 GUI 时自动使用上次的目录 |
| R-007 | 历史目录记录 | P1 | As a user, I want 快速访问最近使用的目录, so that 在常用项目间快速切换 |

### 2.2 验收标准

#### R-001: 工作目录选择
- **WHEN** 用户点击"浏览..."或"切换目录"按钮, **THEN** 系统 **SHALL** 弹出文件夹选择对话框
- **WHEN** 用户在对话框中选择一个目录并确认, **THEN** 系统 **SHALL** 将该目录设置为新的工作目录
- **WHEN** 用户取消选择, **THEN** 系统 **SHALL** 保持当前目录不变

#### R-002: 自动重启服务
- **WHEN** 用户选择新目录且该目录与当前目录不同, **THEN** 系统 **SHALL** 执行以下操作（按顺序）：
  1. 如果服务正在运行，先停止服务
  2. 等待服务完全停止（最多等待 5 秒）
  3. 使用新目录启动服务
- **WHEN** 服务已停止状态下切换目录, **THEN** 系统 **SHALL** 只更新配置，不执行启动
- **WHEN** 切换到与当前相同的目录, **THEN** 系统 **SHALL** 不执行任何操作

#### R-003: 当前目录显示
- **WHEN** GUI 启动或切换目录成功后, **THEN** 系统 **SHALL** 在界面显著位置显示当前工作目录的完整路径
- **WHEN** 路径过长超出显示区域, **THEN** 系统 **SHALL** 使用省略号或 tooltip 显示完整路径

#### R-004: 重启进度提示
- **WHEN** 开始停止服务, **THEN** 系统 **SHALL** 显示"正在停止服务..."
- **WHEN** 开始启动服务, **THEN** 系统 **SHALL** 显示"正在启动服务..."
- **WHEN** 重启完成, **THEN** 系统 **SHALL** 显示成功通知（如"服务已在新目录下启动"）
- **WHEN** 重启过程中, **THEN** 系统 **SHALL** 禁用启动/停止/切换目录按钮

#### R-005: 错误处理
- **WHEN** 选择的目录不存在或路径无效, **THEN** 系统 **SHALL** 显示错误提示"目录不存在或无效"且不执行重启
- **WHEN** 选择的目录没有读写权限, **THEN** 系统 **SHALL** 显示错误提示"权限不足，无法访问该目录"
- **WHEN** 停止服务失败（超时或异常）, **THEN** 系统 **SHALL** 显示错误提示并询问是否强制终止
- **WHEN** 启动服务失败, **THEN** 系统 **SHALL** 显示错误原因（如端口被占用、配置错误）并回滚到原目录

#### R-006: 配置持久化
- **WHEN** 成功切换到新目录, **THEN** 系统 **SHALL** 将新目录路径保存到配置文件（gui_config.json）
- **WHEN** 下次启动 GUI, **THEN** 系统 **SHALL** 从配置文件读取并使用上次保存的目录

#### R-007: 历史目录记录
- **WHEN** 成功切换到新目录, **THEN** 系统 **SHALL** 将该目录添加到历史记录（最多保存 10 条）
- **WHEN** 用户点击"最近目录"或下拉菜单, **THEN** 系统 **SHALL** 显示历史目录列表
- **WHEN** 用户从历史列表选择一个目录, **THEN** 系统 **SHALL** 切换到该目录并触发重启

---

## 3. 功能验收清单

| ID | 功能点 | 验收步骤 | 优先级 | 关联需求 | 通过 |
|----|--------|----------|--------|----------|------|
| F-001 | 目录选择 UI | 1. 点击"浏览"按钮 2. 验证文件夹选择对话框弹出 3. 选择目录后确认 | P0 | R-001 | ☐ |
| F-002 | 当前目录显示 | 1. 启动 GUI 2. 验证显示当前工作目录 3. 切换目录后验证显示更新 | P0 | R-003 | ☐ |
| F-003 | 停止旧服务 | 1. 启动服务 2. 切换目录 3. 验证旧服务被停止 | P0 | R-002 | ☐ |
| F-004 | 启动新服务 | 1. 切换目录 2. 验证新服务在新目录下启动 3. 检查服务日志确认工作目录 | P0 | R-002 | ☐ |
| F-005 | 重启进度提示 | 1. 切换目录 2. 观察状态提示变化 3. 验证"停止中"→"启动中"→"成功"流程 | P0 | R-004 | ☐ |
| F-006 | 按钮状态控制 | 1. 切换目录 2. 验证重启期间启动/停止/切换按钮被禁用 3. 完成后验证按钮恢复 | P0 | R-004 | ☐ |
| F-007 | 目录不存在处理 | 1. 手动输入不存在的路径（如修改配置文件）2. 启动 GUI 3. 验证错误提示 | P0 | R-005 | ☐ |
| F-008 | 权限不足处理 | 1. 选择无权限的系统目录 2. 验证错误提示 3. 验证不执行重启 | P0 | R-005 | ☐ |
| F-009 | 启动失败回滚 | 1. 模拟启动失败（如端口被占用）2. 验证错误提示 3. 验证工作目录回滚到原目录 | P0 | R-005 | ☐ |
| F-010 | 配置持久化 | 1. 切换到新目录 2. 关闭 GUI 3. 重新启动 GUI 4. 验证使用上次目录 | P1 | R-006 | ☐ |
| F-011 | 历史记录功能 | 1. 切换到 3 个不同目录 2. 打开历史下拉菜单 3. 验证显示 3 条记录 4. 点击历史记录验证快速切换 | P1 | R-007 | ☐ |
| F-012 | 历史记录限制 | 1. 切换到 12 个不同目录 2. 验证历史记录只保存最近 10 条 | P1 | R-007 | ☐ |

---

## 4. 技术约束

### 4.1 技术栈
- **GUI 框架**: tkinter（现有技术栈）
- **配置管理**: JSON 格式配置文件（`gui_config.json`）
- **进程管理**: 使用现有的 `ServerController` 类（位于 `src/docx_mcp_server/gui/server_controller.py`）

### 4.2 集成点
- **现有模块**:
  - `DocxServerGUI` 类（主界面）
  - `ServerController` 类（服务启动/停止）
  - 配置加载/保存逻辑
- **新增模块**:
  - 工作目录管理器（`WorkingDirectoryManager`）
  - 历史记录管理（可集成到配置文件）

### 4.3 性能要求
- 文件夹选择对话框打开响应时间 < 500ms
- 服务停止超时时间 ≤ 5 秒
- 服务启动超时时间 ≤ 10 秒
- 配置文件读写响应时间 < 100ms

### 4.4 兼容性
- **操作系统**: Windows, macOS, Linux（tkinter 跨平台支持）
- **Python 版本**: 3.8+（与项目要求一致）

---

## 5. 非功能性需求

### 5.1 可用性
- 目录切换操作应在 3 次点击内完成
- 错误提示应清晰明确，告知用户如何解决问题
- 重启过程应有明显的视觉反馈（进度条或状态文字）

### 5.2 可靠性
- 服务停止失败时不应影响 GUI 稳定性
- 配置文件损坏时应使用默认目录并提示用户
- 切换失败后应自动回滚到原目录

### 5.3 安全性
- 验证用户选择的目录是否有读写权限
- 防止切换到系统敏感目录（可选：白名单/黑名单机制）

---

## 6. UI/UX 设计

### 6.1 界面布局（草图）

```
┌─────────────────────────────────────────┐
│  docx-mcp-server GUI Launcher           │
├─────────────────────────────────────────┤
│                                         │
│  当前工作目录: /home/user/project/docs   │
│  [浏览...] [历史 ▼]                     │
│                                         │
│  服务状态: 运行中                        │
│  [启动服务]  [停止服务]                  │
│                                         │
│  日志输出:                               │
│  ┌───────────────────────────────────┐  │
│  │ [INFO] 服务已启动...              │  │
│  │ [INFO] 工作目录: /home/user/...   │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 6.2 交互流程

```
用户点击"浏览"
    ↓
弹出文件夹选择对话框
    ↓
用户选择目录并确认
    ↓
┌──────────────────────┐
│ 检查目录有效性        │
│ - 是否存在？          │
│ - 是否有权限？        │
└──────────────────────┘
    ↓
┌──────────────────────┐
│ 如果服务正在运行      │
│ 1. 显示"停止中..."   │
│ 2. 停止服务           │
│ 3. 等待停止完成       │
└──────────────────────┘
    ↓
┌──────────────────────┐
│ 更新配置并启动        │
│ 1. 保存新目录到配置   │
│ 2. 添加到历史记录     │
│ 3. 显示"启动中..."   │
│ 4. 启动服务           │
└──────────────────────┘
    ↓
┌──────────────────────┐
│ 完成                  │
│ 1. 显示成功通知       │
│ 2. 更新界面显示       │
│ 3. 恢复按钮状态       │
└──────────────────────┘
```

---

## 7. 数据模型

### 7.1 配置文件结构（gui_config.json）

```json
{
  "version": "1.0",
  "current_working_directory": "/home/user/project/docs",
  "directory_history": [
    "/home/user/project/docs",
    "/home/user/another-project",
    "/home/user/temp-work"
  ],
  "max_history_count": 10,
  "server": {
    "host": "localhost",
    "port": 3000
  }
}
```

### 7.2 历史记录管理
- **数据结构**: 列表（最新的在最前）
- **容量限制**: 最多 10 条
- **去重规则**: 切换到已存在的目录时，将其移到列表最前
- **持久化**: 每次切换成功后立即保存

---

## 8. 异常场景与错误处理

| 异常场景 | 错误提示 | 处理策略 |
|---------|---------|---------|
| 目录不存在 | "目录不存在: {path}" | 不执行切换，保持当前目录 |
| 权限不足 | "权限不足，无法访问: {path}" | 不执行切换，保持当前目录 |
| 停止服务超时 | "服务停止超时，是否强制终止？" | 询问用户，可选强制终止 |
| 启动服务失败 | "服务启动失败: {error_reason}" | 回滚到原目录，恢复原配置 |
| 配置文件损坏 | "配置文件损坏，使用默认目录" | 重置为当前工作目录（os.getcwd()） |
| 历史记录格式错误 | 无提示 | 忽略历史记录，使用空列表 |

---

## 9. 排除项

以下功能**不在**本需求范围内：

1. ❌ **多实例管理**: 不支持同时在多个目录运行多个服务器实例
   - 理由: 单实例已满足当前需求，多实例增加复杂度
2. ❌ **远程目录支持**: 不支持网络路径（如 `\\server\share`）或 SSH 路径
   - 理由: 需要额外的网络连接管理和权限处理
3. ❌ **高级配置**: 不支持不同目录使用不同端口/配置
   - 理由: 增加配置复杂度，当前场景不需要
4. ❌ **数据迁移**: 切换目录时不自动迁移或备份数据
   - 理由: 用户应自行管理文档数据

---

## 10. 测试策略

### 10.1 单元测试
- `WorkingDirectoryManager` 类的目录验证逻辑
- 配置文件读写功能
- 历史记录的添加/去重/限制逻辑

### 10.2 集成测试
- 完整的切换流程：选择目录 → 停止服务 → 启动服务 → 验证
- 错误场景测试：无效目录、权限不足、启动失败

### 10.3 手动测试
- 跨平台测试（Windows, macOS, Linux）
- UI 交互测试（按钮点击、进度提示、错误弹窗）
- 长路径显示测试（超过界面宽度）

---

## 11. 下一步

✅ **需求已明确，可以进入设计阶段**

在新会话中执行：
```bash
/clouditera:dev:spec-dev gui-cwd-switch --skip-requirements
```

或者创建 worktree 隔离开发：
```bash
# 由 clarify 命令自动调用 worktree-manager.sh
# 用户无需手动执行
```

---

## 附录：参考资料

### A. 现有代码位置
- GUI 主文件: `src/docx_mcp_server/gui/launcher.py`
- 服务控制器: `src/docx_mcp_server/gui/server_controller.py`
- 配置文件: `config/gui_config.json`（需确认实际路径）

### B. 相关文档
- docx-server-gui-launcher 设计文档: `docs/dev/docx-server-gui-launcher/`
- CLAUDE.md 项目开发指南: `/home/bluecake/ai/DocAI/docx-mcp-server/CLAUDE.md`
