# 需求文档: Log Search Feature

> **功能标识**: log-search
> **复杂度**: standard
> **生成方式**: clarify
> **生成时间**: 2026-01-22T08:30:00Z

## 1. 概述

### 1.1 一句话描述
为 docx-server-launcher GUI 的日志窗口添加实时高亮搜索功能，支持正则表达式、大小写敏感和搜索结果导航。

### 1.2 核心价值
- **提升调试效率**：快速定位关键日志信息，无需手动滚动查找
- **支持大量日志**：针对 >10000 行日志场景优化性能
- **灵活搜索**：支持正则表达式、大小写敏感等高级搜索选项
- **便捷操作**：实时高亮 + 一键清空日志

### 1.3 目标用户
- **主要用户**：开发者和运维人员，使用 GUI 启动器查看 MCP 服务器日志
- **次要用户**：测试人员，需要从大量日志中筛选特定错误信息

---

## 2. 需求与用户故事

### 2.1 需求清单

| ID | 需求点 | 优先级 | 用户故事 |
|----|--------|--------|----------|
| R-001 | 实时搜索高亮 | P0 | As a 开发者, I want 输入搜索关键词后立即高亮所有匹配项, so that 无需等待即可看到搜索结果 |
| R-002 | 搜索选项控制 | P0 | As a 用户, I want 控制大小写敏感和正则表达式开关, so that 能精确匹配我需要的日志 |
| R-003 | 结果导航 | P1 | As a 用户, I want 通过上/下一个按钮跳转到搜索结果, so that 快速浏览所有匹配位置 |
| R-004 | 清空日志 | P1 | As a 用户, I want 一键清空日志内容, so that 移除旧日志避免干扰 |
| R-005 | 性能优化 | P0 | As a 用户, I want 搜索大量日志(>10000行)时不卡顿, so that 保持流畅的使用体验 |
| R-006 | UI 集成 | P0 | As a 用户, I want 搜索栏自然集成在日志组顶部, so that 界面布局清晰直观 |

### 2.2 验收标准

#### R-001: 实时搜索高亮
- **WHEN** 用户在搜索框中输入文本, **THEN** 系统 **SHALL**:
  - 实时高亮所有匹配的文本（黄色背景）
  - 搜索框为空时移除所有高亮
  - 不干扰日志的自动滚动功能

#### R-002: 搜索选项控制
- **WHEN** 用户勾选/取消"大小写敏感"选项, **THEN** 系统 **SHALL**:
  - 立即重新执行搜索并更新高亮
  - 保存选项状态（下次启动时恢复）
- **WHEN** 用户勾选/取消"正则表达式"选项, **THEN** 系统 **SHALL**:
  - 切换到正则表达式匹配模式
  - 无效正则时在搜索框显示错误提示（红色边框）
  - 保存选项状态

#### R-003: 结果导航
- **WHEN** 用户点击"下一个"按钮, **THEN** 系统 **SHALL**:
  - 滚动到下一个搜索结果位置
  - 当前结果使用不同颜色高亮（橙色背景）
  - 到达最后一个结果时循环回到第一个
- **WHEN** 用户点击"上一个"按钮, **THEN** 系统 **SHALL**:
  - 滚动到上一个搜索结果位置
  - 到达第一个结果时循环到最后一个
- **WHEN** 搜索框显示 "X / Y" 格式的匹配数, **THEN**:
  - X 表示当前结果索引（1-based）
  - Y 表示总匹配数

#### R-004: 清空日志
- **WHEN** 用户点击"清空日志"按钮, **THEN** 系统 **SHALL**:
  - 清除日志窗口的所有内容
  - 清除所有搜索高亮状态
  - 可选：显示确认对话框（如果日志内容超过 100 行）

#### R-005: 性能优化
- **WHEN** 日志内容超过 10000 行, **THEN** 系统 **SHALL**:
  - 搜索响应时间 < 500ms（在现代 PC 上）
  - 使用增量高亮而非全量重绘
  - 不阻塞 UI 主线程（避免界面卡顿）

#### R-006: UI 集成
- **WHEN** GUI 启动, **THEN** 搜索栏 **SHALL**:
  - 位于日志组（QGroupBox）的顶部
  - 包含：搜索输入框、上/下导航按钮、大小写敏感复选框、正则表达式复选框、清空按钮
  - 保持与现有 UI 风格一致（字体、间距、颜色）
  - 支持键盘快捷键：
    - `Ctrl+F` 或 `Cmd+F`：聚焦搜索框
    - `Enter` / `F3`：下一个结果
    - `Shift+Enter` / `Shift+F3`：上一个结果
    - `Esc`：清空搜索框

---

## 3. 功能验收清单

| ID | 功能点 | 验收步骤 | 优先级 | 关联需求 | 通过 |
|----|--------|----------|--------|----------|------|
| F-001 | 搜索框 UI | 1. 启动 GUI<br>2. 检查搜索栏在日志组顶部<br>3. 验证所有控件（输入框、按钮、复选框）存在 | P0 | R-006 | ☐ |
| F-002 | 实时高亮 | 1. 输入搜索文本"ERROR"<br>2. 验证所有"ERROR"文本被黄色高亮<br>3. 清空搜索框，验证高亮消失 | P0 | R-001 | ☐ |
| F-003 | 大小写敏感 | 1. 输入"error"（小写）<br>2. 不勾选大小写敏感，验证匹配"ERROR"和"error"<br>3. 勾选大小写敏感，验证只匹配"error" | P0 | R-002 | ☐ |
| F-004 | 正则表达式 | 1. 勾选正则表达式<br>2. 输入"\d{4}-\d{2}-\d{2}"（日期格式）<br>3. 验证日期字符串被高亮<br>4. 输入无效正则"[("，验证错误提示 | P0 | R-002 | ☐ |
| F-005 | 结果导航 | 1. 搜索"INFO"<br>2. 点击"下一个"，验证滚动到第一个匹配<br>3. 验证当前结果橙色高亮<br>4. 点击"上一个"，验证循环导航 | P1 | R-003 | ☐ |
| F-006 | 结果计数 | 1. 搜索"ERROR"<br>2. 验证显示"1 / 5"（表示第 1 个，共 5 个）<br>3. 点击"下一个"，验证变为"2 / 5" | P1 | R-003 | ☐ |
| F-007 | 清空日志 | 1. 生成 >100 行日志<br>2. 点击"清空日志"<br>3. 验证显示确认对话框<br>4. 确认后日志窗口清空 | P1 | R-004 | ☐ |
| F-008 | 性能测试 | 1. 生成 15000 行日志（使用循环发送日志）<br>2. 搜索常见关键词"INFO"<br>3. 验证搜索响应时间 < 500ms<br>4. 验证界面无卡顿 | P0 | R-005 | ☐ |
| F-009 | 键盘快捷键 | 1. 按 `Ctrl+F`，验证搜索框获得焦点<br>2. 输入文本后按 `Enter`，验证跳转到下一个结果<br>3. 按 `Esc`，验证搜索框清空 | P1 | R-006 | ☐ |
| F-010 | 状态持久化 | 1. 勾选"大小写敏感"和"正则表达式"<br>2. 关闭 GUI<br>3. 重新启动，验证选项状态恢复 | P1 | R-002 | ☐ |

---

## 4. 技术约束

### 4.1 技术栈
- **GUI 框架**: PyQt6
- **文本组件**: `QPlainTextEdit` (现有日志窗口)
- **高亮机制**: `QTextEdit.ExtraSelection` (Qt 标准高亮方式)
- **正则引擎**: Python `re` 模块
- **设置持久化**: `QSettings` (现有机制)

### 4.2 集成点
- **修改文件**: `src/docx_server_launcher/gui/main_window.py`
- **可选新建**: `src/docx_server_launcher/gui/log_search_widget.py` (封装搜索组件)
- **依赖**: 无新增外部依赖，使用 PyQt6 内置功能

### 4.3 性能要求
- **搜索延迟**: 输入后 < 300ms 开始高亮（防抖）
- **高亮刷新**: 使用 `QTextEdit.setExtraSelections()` 批量更新，避免逐行重绘
- **大日志优化**: 考虑使用 `QRegularExpression` (Qt C++ 正则) 替代 Python `re`
- **内存限制**: 高亮信息占用内存 < 10MB (对于 10000 行场景)

### 4.4 兼容性
- **平台**: Windows, macOS, Linux (PyQt6 跨平台)
- **Qt 版本**: PyQt6 >= 6.0
- **Python 版本**: Python >= 3.9 (项目现有要求)

---

## 5. 排除项

- **不支持正则语法提示**：输入正则时不提供自动完成或语法校验（仅显示错误提示）
- **不支持搜索历史**：不保存历史搜索记录
- **不支持导出搜索结果**：不支持将匹配的日志行导出到文件
- **不支持多关键词组合**：不支持 AND/OR/NOT 逻辑组合搜索
- **不支持搜索替换**：仅搜索高亮，不支持替换日志内容（因为日志是只读的）

**排除原因**：
- 这些功能会显著增加复杂度（从 standard 升级到 complex）
- 对于日志查看场景，实时高亮和导航已满足核心需求
- 可在后续迭代中根据用户反馈添加

---

## 6. UI 设计草图

### 6.1 布局结构

```
┌─ Logs ────────────────────────────────────────┐
│ ┌──────────────────────────────────────────┐ │
│ │ [Search: ___________] [↑] [↓] [1/5]      │ │
│ │ ☐ Case Sensitive  ☐ Regex  [Clear]      │ │
│ └──────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────────┐ │
│ │ [2025-01-22 10:00:00] INFO Server started │ │
│ │ [2025-01-22 10:00:01] ERROR Connection failed ← 黄色高亮
│ │ [2025-01-22 10:00:02] INFO Retrying...    │ │
│ │ [2025-01-22 10:00:03] ERROR Timeout      │ ← 橙色高亮（当前结果）
│ │ ...                                        │ │
│ └────────────────────────────────────────────┘ │
└───────────────────────────────────────────────┘
```

### 6.2 控件说明

| 控件 | 类型 | 说明 |
|------|------|------|
| Search | `QLineEdit` | 搜索输入框，支持键盘快捷键 `Ctrl+F` 聚焦 |
| ↑ / ↓ | `QPushButton` | 上一个/下一个结果按钮 |
| 1/5 | `QLabel` | 显示当前结果/总数 |
| Case Sensitive | `QCheckBox` | 大小写敏感开关 |
| Regex | `QCheckBox` | 正则表达式开关 |
| Clear | `QPushButton` | 清空日志按钮 |

---

## 7. 下一步

✅ **需求已澄清，可以进入开发阶段**

### 7.1 开发步骤（建议）
1. **阶段1：基础 UI**
   - 在 `main_window.py` 的 `log_group` 中添加搜索栏布局
   - 添加所有控件（输入框、按钮、复选框）

2. **阶段2：实时高亮**
   - 实现搜索框文本变化监听
   - 使用 `QTextEdit.ExtraSelection` 高亮所有匹配
   - 添加防抖逻辑（300ms 延迟）

3. **阶段3：搜索选项**
   - 实现大小写敏感切换
   - 实现正则表达式支持
   - 添加无效正则的错误提示

4. **阶段4：结果导航**
   - 实现上/下一个结果跳转
   - 当前结果使用不同颜色高亮
   - 显示结果计数

5. **阶段5：附加功能**
   - 实现清空日志按钮
   - 添加键盘快捷键支持
   - 状态持久化（`QSettings`）

6. **阶段6：性能优化**
   - 使用大量日志测试
   - 优化高亮算法（批量更新）
   - 验证性能目标

### 7.2 执行命令（在当前会话）

由于用户选择在主工作区继续，可以直接开始实施：

```bash
# 方式1：使用 spec-dev 命令生成设计文档和任务清单
/clouditera:dev:spec-dev log-search --skip-requirements --no-worktree

# 方式2：直接开始编码（如果你已经清楚实现方案）
# 可以直接告诉我："开始实现搜索功能"
```

---

## 8. 附录

### 8.1 参考资料
- [PyQt6 QTextEdit ExtraSelection](https://doc.qt.io/qt-6/qtextedit.html#extraSelections-prop)
- [PyQt6 QSettings](https://doc.qt.io/qt-6/qsettings.html)
- [Python re 模块](https://docs.python.org/3/library/re.html)

### 8.2 类似功能参考
- VS Code 日志搜索功能
- Chrome DevTools Console 搜索
- PyCharm 日志查看器

### 8.3 风险与挑战
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 大量日志导致搜索卡顿 | 高 | 使用增量高亮 + 防抖 + Qt C++ 正则 |
| 正则表达式性能问题 | 中 | 限制正则复杂度，显示性能警告 |
| 高亮颜色与主题冲突 | 低 | 使用 Qt 样式表动态调整颜色 |

---

**文档版本**: v1
**最后更新**: 2026-01-22
**作者**: Claude (via /clouditera:dev:clarify)
