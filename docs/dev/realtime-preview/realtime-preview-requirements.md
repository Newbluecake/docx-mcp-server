---
feature: realtime-preview
complexity: standard
generated_by: clarify
generated_at: 2026-01-23T12:00:00Z
version: 1
---

# 需求文档: 实时文档预览 (Realtime Preview)

> **功能标识**: realtime-preview
> **复杂度**: standard
> **生成方式**: clarify
> **生成时间**: 2026-01-23

## 1. 概述

### 1.1 一句话描述
为 docx-mcp-server 提供本地实时预览功能，允许在 MCP 操作文档时自动触发系统默认的 Office 软件（Word/WPS）更新显示内容。

### 1.2 核心价值
- **即时反馈**：Agent 在编辑文档时可以即时看到视觉效果，确认排版和格式正确。
- **无缝集成**：无需专门的预览器，直接利用用户本地已安装的强大 Office 软件。
- **提升体验**：解决 MCP 操作 "盲写" 的痛点，提供类似 "Live Server" 的开发体验。

### 1.3 目标用户
- **主要用户**：使用 Claude Desktop 开发文档自动化流程的开发者。
- **次要用户**：使用 docx-mcp-server 进行文档生成的 Agent（通过视觉反馈验证结果）。

---

## 2. 需求与用户故事

### 2.1 需求清单

| ID | 需求点 | 优先级 | 用户故事 |
|----|--------|--------|----------|
| R-001 | 自动触发预览 | P0 | 作为用户，通过 MCP 修改文档后，希望预览窗口在 3 秒内自动刷新，无需手动操作。 |
| R-002 | 文件锁定处理 | P0 | 作为用户，我不希望因为预览窗口打开而导致 MCP 写入失败（文件被锁定）。 |
| R-003 | 跨平台支持 | P0 | 作为用户，无论在 Windows 还是 macOS，都能调用系统关联的程序进行预览。 |
| R-004 | 优雅降级 | P1 | 作为用户，如果我没有安装 Office 软件，MCP 操作应正常完成，仅提示无法预览。 |
| R-005 | 多会话隔离 | P1 | 作为用户，如果我同时操作多个文档，预览窗口应分别对应，互不干扰。 |

### 2.2 验收标准

#### R-001: 自动触发预览
- **WHEN** 调用 `docx_insert_paragraph` 等修改性工具完成，**THEN** 系统自动触发预览刷新逻辑。
- **WHEN** 预览刷新，**THEN** 本地 Office 窗口应在 3 秒内显示最新内容。

#### R-002: 文件锁定处理
- **WHEN** Word 打开预览文件时，**THEN** MCP 对文档的写入操作不应报错（PermissionDenied）。
- **WHEN** 写入完成，**THEN** 预览窗口应能加载新的内容。

#### R-003: 跨平台支持
- **WHEN** 在 Windows 环境，**THEN** 使用 `start` 命令调用关联程序。
- **WHEN** 在 macOS 环境，**THEN** 使用 `open` 命令调用关联程序。

#### R-004: 优雅降级
- **WHEN** 系统未安装 Office 软件，**THEN** MCP 工具返回成功，并在日志/消息中提示 "Preview skipped: no viewer found"。

---

## 3. 功能验收清单

| ID | 功能点 | 验收步骤 | 优先级 | 关联需求 | 通过 |
|----|--------|----------|--------|----------|------|
| F-001 | 预览开关控制 | 1. 在 `docx_create` 时传入 `preview=True` <br> 2. 验证仅在开启时触发预览 | P1 | R-001 | ☐ |
| F-002 | 副本写入机制 | 1. 开启预览 <br> 2. 手动用 Word 打开目标文件 <br> 3. 调用 MCP 写入 <br> 4. 验证写入成功且 Word 内容更新 | P0 | R-002 | ☐ |
| F-003 | Windows 适配 | 1. 在 Windows 运行服务器 <br> 2. 执行操作 <br> 3. 验证 Word 窗口弹出/刷新 | P0 | R-003 | ☐ |
| F-004 | macOS 适配 | 1. 在 macOS 运行服务器 <br> 2. 执行操作 <br> 3. 验证 Word/Pages 窗口弹出/刷新 | P0 | R-003 | ☐ |

---

## 4. 技术约束

### 4.1 技术栈
- **Python**: 使用 `subprocess` 模块进行系统调用。
- **OS**: Windows (start), macOS (open)。
- **依赖**: 不引入新的重型依赖，仅使用标准库。

### 4.2 核心机制（副本编辑模式）
为解决 Word 文件锁定问题，采用以下机制：
1. **工作副本**：MCP 始终操作临时文件或影子副本。
2. **预览副本**：预览时将内容写入一个专门的 "预览文件"（如 `doc_preview.docx`）。
3. **刷新策略**：
   - 方案 A（简单）：每次生成新文件名为 `doc_preview_{timestamp}.docx` 并打开（会导致多窗口，需权衡）。
   - 方案 B（推荐）：尝试覆盖 `doc_preview.docx`。如果被锁定，提示用户关闭或使用备用名。
   - *技术决策*：鉴于 R-002 的高优先级，建议采用 **"分离式架构"**：MCP 维护内部状态，仅在需要预览时导出临时文件并打开。

### 4.3 同步方向
- **单向同步**：MCP -> Word。
- **只读预览**：用户在预览窗口的修改**不会**同步回 MCP 会话（会被下一次更新覆盖）。

---

## 5. 排除项

- **双向同步**：不支持将用户在 Word 中的手动修改同步回 MCP。
- **Web 预览**：本次迭代不支持在浏览器中预览（仅限本地应用）。
- **Linux 支持**：优先支持 Win/Mac，Linux 桌面环境暂不作为验收标准。
- **精确光标同步**：预览窗口只需显示内容，无需同步光标位置。

---

## 6. 下一步

✅ 需求已澄清，建议在新会话中执行：

```bash
/clouditera:dev:spec-dev realtime-preview --skip-requirements --no-worktree
```
