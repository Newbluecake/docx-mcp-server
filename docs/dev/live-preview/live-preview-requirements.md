---
feature: live-preview
complexity: standard
generated_by: clarify
generated_at: 2026-01-21T10:00:00Z
version: 1
---

# 需求文档: Word/WPS 实时预览支持

> **功能标识**: live-preview
> **复杂度**: standard
> **生成方式**: clarify
> **生成时间**: 2026-01-21

## 1. 概述

### 1.1 一句话描述
在 Windows 环境下，使 docx-mcp-server 支持通过 COM 自动化技术连接已打开的 WPS 或 Microsoft Word 进程，实现在 MCP 修改文档后自动刷新编辑器显示，达到"边改边看"的效果。

### 1.2 核心价值
- **提升反馈效率**：开发者无需反复关闭并重新打开文档来验证 MCP 操作的结果。
- **无缝集成**：保持用户现有的 WPS/Word 使用习惯，无需切换到其他预览工具。
- **兼容性**：同时支持国内主流的 WPS Office 和国际标准的 Microsoft Office。

### 1.3 目标用户
- **主要用户**：使用 Claude 和 docx-mcp-server 开发文档生成/处理流程的 Windows 开发者。
- **次要用户**：需要实时监控文档自动化处理结果的业务人员。

---

## 2. 需求与用户故事

### 2.1 需求清单

| ID | 需求点 | 优先级 | 用户故事 |
|----|--------|--------|----------|
| R-001 | 进程识别与连接 | P0 | 作为开发者，我希望系统能自动识别并连接已打开的 Word 或 WPS 进程，以便控制其行为。 |
| R-002 | 实时刷新机制 | P0 | 作为开发者，我希望在 MCP 执行保存操作后，编辑器能在 1-3 秒内自动刷新显示最新内容。 |
| R-003 | 双编辑器兼容 | P1 | 作为开发者，我希望无论使用 WPS 还是 Word，都能获得一致的实时预览体验。 |
| R-004 | 错误处理与降级 | P2 | 作为开发者，当 COM 连接失败或编辑器未打开时，我希望系统能平滑降级到普通模式而不报错。 |

### 2.2 验收标准

#### R-001: 进程识别与连接
- **WHEN** 启动 MCP 服务或建立 Session 时，**THEN** 系统尝试连接活动的 `Word.Application` 或 `KWPS.Application` (WPS) COM 对象。
- **WHEN** 多个实例运行时，**THEN** 优先连接与当前 Session 文件路径匹配的文档窗口。

#### R-002: 实时刷新机制
- **WHEN** 调用 `docx_save()` 完成后，**THEN** 触发对应 COM 对象的刷新/重载方法。
- **WHEN** 刷新操作完成，**THEN** 编辑器前台显示更新后的文档内容。

#### R-003: 双编辑器兼容
- **WHEN** 环境中安装了 WPS，**THEN** 能够通过 `ket.Application` 或类似 ProgID 连接。
- **WHEN** 环境中安装了 Office，**THEN** 能够通过 `Word.Application` 连接。
- **WHEN** 两者共存，**THEN** 根据用户打开文档的程序自动判断。

---

## 3. 功能验收清单

| ID | 功能点 | 验收步骤 | 优先级 | 关联需求 | 通过 |
|----|--------|----------|--------|----------|------|
| F-001 | COM 连接管理器 | 1. 启动服务 2. 检测日志是否显示 "Connected to Word/WPS" | P0 | R-001 | ☐ |
| F-002 | 保存后自动刷新 | 1. 打开文档 2. MCP 调用 `docx_add_paragraph` + `docx_save` 3. 观察编辑器内容是否变化 | P0 | R-002 | ☐ |
| F-003 | WPS 兼容性适配 | 1. 使用 WPS 打开文档 2. 重复 F-002 测试 | P1 | R-003 | ☐ |
| F-004 | 优雅降级 | 1. 关闭所有编辑器 2. 运行 MCP 操作 3. 确认操作成功且无崩溃 | P2 | R-004 | ☐ |

---

## 4. 技术约束

### 4.1 技术栈
- **语言/框架**：Python 3.10+
- **核心依赖**：`pywin32` (win32com) 或 `comtypes` (用于 COM 交互)
- **操作系统**：Windows 10/11 (COM 仅支持 Windows)

### 4.2 集成点
- **Session Manager**：需要扩展 Session 管理，增加 COM 对象引用的持有和释放。
- **docx_save**：需要 Hook 保存操作，在文件写入磁盘后触发 COM 刷新。

### 4.3 风险控制
- **文件锁定**：Word/WPS 打开文件时可能会锁定文件，导致 python-docx 无法保存。需要处理文件占用问题（如 COM 另存为或先关闭再打开）。
- **性能影响**：COM 调用较慢，需确保不阻塞 MCP 主线程过久。

---

## 5. 排除项

- **非 Windows 支持**：macOS/Linux 不支持 COM，此功能在非 Windows 平台自动禁用。
- **复杂交互**：不支持通过 MCP 控制光标位置、选区等 UI 交互，仅限内容刷新。
- **流式预览**：不支持逐字逐句的实时流式显示，仅支持保存后的刷新。

---

## 6. 下一步

✅ 在新会话中执行：
```bash
/clouditera:dev:spec-dev live-preview --skip-requirements
```
